(function($){function buildHTML(elm,ids,template,_products,callState){var products=[];for(var i=0;i<ids.length;i++){var id=ids[i];for(var j=0;j<_products.length;j++){if(_products[j]["id"]==id){products[i]=_products[j];break}}}elm.append(renderTemplate($(template).html(),products));for(var i=0;i<products.length;i++){var product=products[i];$('a[tsd="id-'+product.id+'"]').each(function(i,link){function do_continue(timeout){if(typeof timeout!="undefined"){window.clearTimeout(timeout)}if(typeof onclick!="undefined"){link.__tsd_onclick=function(){eval(onclick)};link.__tsd_onclick()}var href=$(link).attr("href");if(typeof href!="undefined"){window.location.href=href}}var onclick=$(link).attr("onclick");$(link).removeAttr("tsd");$(link).removeAttr("onclick");$(link).click(product,function(a){a.preventDefault();if(settings.ga_tracking!=null&&typeof _gaq!="undefined"){_gaq.push(["_trackEvent",settings.ga_tracking,callState.api,a.data.id+": "+a.data.name])}var b=window.setTimeout(do_continue,500);callAPI("log_click",{product:a.data.id,api:callState.api},function(){do_continue(b)});return false})})}}function renderTemplate(a,b){a=Handlebars.compile(a);var c="";for(var d=0;d<b.length;d++){c+=a(b[d]).replace(new RegExp("<a ","g"),'<a tsd="id-'+b[d].id+'"')}return c}function callAPI(a,b,c){b.key=settings.key;var d="http://api.thesocialdigits.com/v1/"+a+"?callback=?";var e={payload:toJSON(b)};$.getJSON(d,e,c)}function toJSON(a){if(window.Prototype){return Object.toJSON(a)}else{return JSON.stringify(a)}}language_mapping={da:"danish",nl:"dutch",en:"english",fi:"finnish",fr:"french",de:"german",it:"italian",no:"norwegian",nb:"norwegian",pt:"portuguese",ru:"russian",es:"spanish",sv:"swedish",us:"english"};var settings={key:"",ga_tracking:"The Social Digits"};$.thesocialdigits=function(a){$.extend(settings,a);if(!("language"in settings)){var b=$("html").attr("lang");if(b in language_mapping){settings.language=language_mapping[b]}}if(!("datasource"in settings)){settings.datasource=function(a,b){var c={products:a};if("language"in settings){c.language=settings.language}callAPI("attributes",c,b)}}if(!("error"in settings)){settings.error=function(a){if(typeof console!="undefined"){if(a.response!=null&&a.response.status=="error"){console.error(a.response.type+": "+a.response.message)}else if("timeout"in settings){console.error("Request timed out.")}else{console.error("Unknown error.")}}}}};$.fn.thesocialdigits=function(a,b,c,d,e){var f=this;var g={api:a,args:b,template:c,element:f,response:null};if("timeout"in settings){var h=window.setTimeout(function(){settings.error(g)},settings.timeout)}callAPI(a,b,function(a){g.response=a;if(typeof h!="undefined"){window.clearTimeout(h)}if("result"in a){settings.datasource(a.result,function(b){buildHTML(f,a.result,c,b,g);if(typeof e==="function"){e(g)}})}else if("status"in a&&a.status!="ok"){settings.error(g)}if(typeof d==="function"){d(g)}})}})(jQuery)