(function($){function buildHTML(elm,ids,template,_products,callState){var products=[];for(var i=0;i<ids.length;i++){var id=ids[i];for(var j=0;j<_products.length;j++){if(_products[j]["id"]==id){products[i]=_products[j];break}}}elm.append(renderTemplate($(template).html(),products));for(var i=0;i<products.length;i++){(function(product){$('a[tsd="id-'+product.id+'"]').each(function(i,link){function do_continue(timeout){if(typeof timeout!="undefined"){window.clearTimeout(timeout)}if(typeof onclick!="undefined"){link.__tsd_onclick=function(){eval(onclick)};link.__tsd_onclick()}var href=$(link).attr("href");if(typeof href!="undefined"){window.location.href=href}}var onclick=$(link).attr("onclick");$(link).removeAttr("tsd");$(link).removeAttr("onclick");$(link).click(function(e){e.preventDefault();if(settings.ga_tracking!=null&&typeof _gaq!="undefined"){_gaq.push(["_trackEvent",settings.ga_tracking,callState.api,product.id+": "+product.name])}var t=window.setTimeout(do_continue,500);callAPI("log/click",{product:product.id,api:callState.api,args:callState.args},function(){do_continue(t)});return false})})})(products[i])}}function renderTemplate(e,t){e=Handlebars.compile(e);var n="";for(var r=0;r<t.length;r++){n+=e(t[r]).replace(new RegExp("<a ","g"),'<a tsd="id-'+t[r].id+'"')}return n}function callAPI(e,t,n){var r="https:"==document.location.protocol?"https":"http";var i=r+"://api.thesocialdigits.com/v2/"+e+"?callback=?";t.key=settings.key;var s={payload:toJSON(t)};$.getJSON(i,s,n)}function toJSON(e){if(window.Prototype){return Object.toJSON(e)}else{return JSON.stringify(e)}}language_mapping={da:"danish",nl:"dutch",en:"english",fi:"finnish",fr:"french",de:"german",it:"italian",no:"norwegian",nb:"norwegian",pt:"portuguese",ru:"russian",es:"spanish",sv:"swedish",us:"english"};var settings={key:"",ga_tracking:"The Social Digits"};$.thesocialdigits=function(e){$.extend(settings,e);if(!("language"in settings)){var t=$("html").attr("lang");if(t in language_mapping){settings.language=language_mapping[t]}}if(!("datasource"in settings)){settings.datasource=function(e,t){var n={products:e};if("language"in settings){n.language=settings.language}callAPI("product/attributes",n,t)}}if(!("error"in settings)){settings.error=function(e){if(typeof console!="undefined"){if(e.response!=null&&e.response.status=="error"){console.error(e.response.type+": "+e.response.message+". More info at "+e.response.moreInfo)}else if("timeout"in settings){console.error("Request timed out.")}else{console.error("Unknown error!")}}}}};$.fn.thesocialdigits=function(e,t,n,r,i){var s=this;var o={api:e,args:t,template:n,element:s,response:null};if("timeout"in settings){var u=window.setTimeout(function(){settings.error(o)},settings.timeout)}callAPI(e,t,function(e){o.response=e;if(typeof u!="undefined"){window.clearTimeout(u)}if("result"in e){settings.datasource(e.result,function(t){buildHTML(s,e.result,n,t,o);if(typeof i==="function"){i(o)}})}else if("status"in e&&e.status!="ok"){settings.error(o)}if(typeof r==="function"){r(o)}})}})(jQuery)